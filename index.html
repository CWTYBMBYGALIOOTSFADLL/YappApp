<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat App with Member List and File Upload</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');
    :root {
      --dark-bg: radial-gradient(circle at 0% 0%, #22242e 0.01%, #18181B 20%);
      --darker-bg: #181818;
      --text-color: #D4D4D4;
      --hover-color: #f3f3f3;
      --hover-color2: #ffffff;
      --button-bg: #18181b;
      --border: #2b2b31;
      --golden: #a3b3ff;
      --grayout-bg: #555759;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto Mono', monospace;
      font-weight: 350;
    }
    body {
      background: var(--dark-bg);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Container for chat and members */
    .app-container {
      flex: 1;
      display: flex;
      margin: 16px 20px 10px 20px;
      gap: 16px;
      overflow: hidden;
    }
    /* Member list panel */
    .members-panel {
      width: 200px;
      background: var(--button-bg);
      border: solid 1.5px var(--border);
      border-radius: 10px 10px 0px 0px;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }
    .members-panel.collapsed {
      width: 40px;
      padding: 12px 8px;
    }
    .members-title {
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--golden);
      user-select: none;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .members-panel.collapsed .members-title {
      margin-bottom: 0;
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      font-size: 0.9em;
      padding: 4px 0;
    }
    .members-list-container {
      flex: 1;
      overflow-y: auto;
    }
    .members-panel.collapsed .members-list-container {
      display: none;
    }
    .member-item {
      padding: 6px 10px;
      border-radius: 8px;
      border: solid 1.5px var(--border);
      margin-bottom: 8px;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: default;
      transition: background-color 0.2s ease;
    }
    .member-item.me {
      background-color: var(--golden);
      color: var(--darker-bg);
      font-weight: 700;
    }
    .member-item:hover {
      background-color: #4b4f68;
    }
    /* Chat container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px 16px;
      overflow-y: auto;
      border: solid 1.5px var(--border);
      background-color: var(--darker-bg);
      border-radius: 10px 10px 0px 0px;;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    .chat-container::-webkit-scrollbar {
      width: 8px;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background-color: var(--border);
      border-radius: 8px;
    }
    /* Message rows */
    .message-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      max-width: 75%;
    }
    .message-row.me {
      align-self: flex-end;
    }
    .message-sender {
      font-size: 0.75em;
      color: #9999cc;
      margin-bottom: 2px;
      user-select: none;
    }
    .message-sender.me {
      color: var(--golden);
      font-weight: 700;
    }
    .bubble {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.4;
      white-space: normal;
      word-break: break-word;
      word-wrap: break-word;
      background-color: var(--button-bg);
      color: var(--text-color);
      border: solid 1.5px var(--border);
      transition: background-color 0.15s ease;
      max-width: 100%;
    }
    .bubble.me {
      background-color: var(--golden);
      color: var(--darker-bg);
    }
    /* Input area */
    .input-area {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background-color: var(--button-bg);
      border: solid 1.5px var(--border);
      border-radius: 0 0 10px 10px;
      margin: 0 20px 20px 20px;
      transition: background-color 0.3s ease;
      gap: 8px;
    }
    .input-area.grayout {
      background-color: var(--grayout-bg);
      pointer-events: none;
      opacity: 0.6;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 20px;
      background-color: var(--darker-bg);
      color: var(--text-color);
      font-family: 'Roboto Mono', monospace;
      font-weight: 350;
      font-size: 1em;
      transition: background-color 0.15s ease;
    }
    input[type="text"]:focus {
      background-color: #23232a;
    }
    input[type="text"]:disabled {
      background-color: #555759;
      color: #a0a0a0;
      cursor: not-allowed;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      background-color: var(--golden);
      color: var(--darker-bg);
      cursor: pointer;
      font-family: 'Roboto Mono', monospace;
      font-weight: 600;
      font-size: 1em;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #8f9ee8;
    }
    button:disabled {
      background-color: #888a8f;
      cursor: not-allowed;
    }
    /* File input button */
    .file-upload-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--golden);
      color: var(--darker-bg);
      cursor: pointer;
      font-size: 1.5em;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .file-upload-label:hover {
      background-color: #8f9ee8;
    }
    .file-upload-input {
      display: none;
    }
    /* Overlay for name input */
    #name-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(24, 24, 27, 0.85);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 12px;
    }
    #name-overlay input {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      font-family: 'Roboto Mono', monospace;
      font-weight: 350;
      font-size: 1.2em;
      width: 240px;
      border: none;
      text-align: center;
    }
    #name-overlay button {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      background-color: var(--golden);
      color: var(--darker-bg);
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.2s ease;
      width: 240px;
    }
    #name-overlay button:hover {
      background-color: #8f9ee8;
    }
    /* File download link style */
    .file-link {
      color: var(--golden);
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Overlay asking for name -->
  <div id="name-overlay">
    <input id="name-input" placeholder="Enter your display name" maxlength="20" />
    <button id="name-submit">Join Chat</button>
  </div>

  <div class="app-container" style="display:none;">
    <div class="members-panel" id="members-panel">
      <div class="members-title" id="members-title" title="Click to toggle members list">Members</div>
      <div class="members-list-container" id="members-list"></div>
    </div>
    <div class="chat-container" id="chat">
      <!-- messages go here -->
    </div>
  </div>

  <form class="input-area" id="chat-form" style="display:none;">
    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" />
    <label for="file-upload" class="file-upload-label" title="Upload file">ðŸ“‚</label>
    <input type="file" id="file-upload" class="file-upload-input" />
    <button type="submit">Send</button>
  </form>

<script>
(() => {
  let myName = null;
  let ws = null;
  const SECRET_KEY = 'a9f3d2b7e8c14f5d9a7b3c6e0f1d2a4b'; // replace with your server secret key

  const nameOverlay = document.getElementById('name-overlay');
  const nameInput = document.getElementById('name-input');
  const nameSubmit = document.getElementById('name-submit');

  const appContainer = document.querySelector('.app-container');
  const chatForm = document.getElementById('chat-form');
  const chat = document.getElementById('chat');
  const membersList = document.getElementById('members-list');
  const messageInput = document.getElementById('message-input');
  const inputArea = document.querySelector('.input-area');
  const membersPanel = document.getElementById('members-panel');
  const membersTitle = document.getElementById('members-title');

  const fileUploadInput = document.getElementById('file-upload');

  // Spam protection variables
  let consecutiveMessages = 0;
  let lastMessageTimestamp = 0;
  const SPAM_LIMIT = 5;
  const SPAM_INTERVAL_MS = 3000; // reset count if > 3s between messages
  const GRAYOUT_DURATION_MS = 5000;

  // Update member list UI from server list
  function updateMemberList(list) {
    membersList.innerHTML = '';
    list.forEach(name => {
      const div = document.createElement('div');
      div.className = 'member-item';
      if (name === myName) div.classList.add('me');
      div.textContent = name;
      membersList.appendChild(div);
    });
  }

  // Add message to chat UI
  function addMessage(sender, text) {
    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;

    const row = document.createElement('div');
    row.className = 'message-row';
    if (sender === myName) row.classList.add('me');

    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    if (sender === myName) senderDiv.classList.add('me');
    senderDiv.textContent = sender;

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    if (sender === myName) bubble.classList.add('me');

    // Detect file message format [file:URL]::type::name
    const fileMatch = text.match(/^\[file:(.+)\]::(.+)::(.+)$/);
    if (fileMatch) {
      const fileUrl = fileMatch[1];
      const fileType = fileMatch[2];
      const fileName = fileMatch[3];

      if (fileType.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = fileUrl;
        img.alt = fileName;
        img.style.maxWidth = '200px';
        img.style.borderRadius = '8px';
        bubble.appendChild(img);
      } else {
        const link = document.createElement('a');
        link.href = fileUrl;
        link.textContent = `Download ${fileName}`;
        link.target = '_blank';
        bubble.appendChild(link);
      }
    } else {
      // regex to detect tenor page URL
      const tenorPageRegex = /https?:\/\/tenor\.com\/view\/[\w-]+-(\d+)/i;
      const tenorMatch = text.match(tenorPageRegex);

      if (tenorMatch) {
        const gifId = tenorMatch[1];
        const embedUrl = `https://tenor.com/embed/${gifId}`;
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.width = 250;
        iframe.height = 200;
        iframe.frameBorder = 0;
        iframe.allowFullscreen = true;
        bubble.appendChild(iframe);
      } else {
        // detect direct image URL
        const imageUrlRegex = /(https?:\/\/\S+\.(png|jpe?g|gif|webp|bmp|svg))(\?\S*)?$/i;
        if (imageUrlRegex.test(text.trim())) {
          const img = document.createElement('img');
          img.src = text.trim();
          img.alt = 'Image';
          img.style.maxWidth = '200px';
          img.style.borderRadius = '8px';
          bubble.appendChild(img);
        } else {
          // Otherwise show normal text
          bubble.textContent = text;
        }
      }
    }

    row.appendChild(senderDiv);
    row.appendChild(bubble);
    chat.appendChild(row);

    if (isNearBottom) {
      chat.scrollTop = chat.scrollHeight;
    }
  }

  // Gray out input area for 5 seconds on spam
  function grayOutInput() {
    inputArea.classList.add('grayout');
    messageInput.disabled = true;
    fileUploadInput.disabled = true;
    chatForm.querySelector('button[type="submit"]').disabled = true;

    addMessage('System', 'You are sending messages too fast. Please wait 5 seconds.');

    setTimeout(() => {
      inputArea.classList.remove('grayout');
      messageInput.disabled = false;
      fileUploadInput.disabled = false;
      chatForm.querySelector('button[type="submit"]').disabled = false;
      messageInput.focus();
      consecutiveMessages = 0;
    }, GRAYOUT_DURATION_MS);
  }

  // Connect to WebSocket server with secret auth
  function connectWebSocket() {
    // Replace with your WSS server URL - use wss:// for secure connection if site uses HTTPS
    const wsUrl = 'wss://1a7c9841359a.ngrok-free.app';
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      // Send secret key first to authenticate
      ws.send(JSON.stringify({ type: 'auth', key: SECRET_KEY }));
    };

    ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);

        if (msg.type === 'auth_success') {
          // Now send join after successful auth
          ws.send(JSON.stringify({ type: 'join', username: myName }));
          addMessage('System', 'Authentication succeeded. Welcome to the chat!');
          chatForm.style.display = 'flex';
          inputArea.classList.remove('grayout');
          messageInput.disabled = false;
          fileUploadInput.disabled = false;
          chatForm.querySelector('button[type="submit"]').disabled = false;
          messageInput.focus();
        } else if (msg.type === 'auth_failed') {
          addMessage('System', 'Authentication failed. Closing connection.');
          ws.close();
        } else if (msg.type === 'members') {
          updateMemberList(msg.list);
        } else if (msg.type === 'message') {
          if (msg.message) {
            const { sender, text } = msg.message;
            addMessage(sender, text);
          } else if (msg.sender && msg.text) {
            addMessage(msg.sender, msg.text);
          } else if (msg.text) {
            addMessage('System', msg.text);
          } else {
            console.warn('Received malformed message:', msg);
          }
        }
      } catch (e) {
        console.error('Invalid message from server', e);
      }
    };

    ws.onclose = () => {
      addMessage('System', 'Disconnected from server. Reconnecting in 3 seconds...');
      chatForm.style.display = 'none';
      setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (err) => {
      console.error('WebSocket error', err);
      ws.close();
    };

    // Disable input until auth succeeds
    chatForm.style.display = 'none';
    inputArea.classList.add('grayout');
    messageInput.disabled = true;
    fileUploadInput.disabled = true;
    chatForm.querySelector('button[type="submit"]').disabled = true;
  }

  // Send message handler
  function sendMessage(e) {
    e.preventDefault();

    if (!ws || ws.readyState !== WebSocket.OPEN) return;

    const text = messageInput.value.trim();
    if (text === '') return;

    const now = Date.now();
    if (now - lastMessageTimestamp > SPAM_INTERVAL_MS) {
      consecutiveMessages = 0;
    }
    lastMessageTimestamp = now;
    consecutiveMessages++;
    if (consecutiveMessages > SPAM_LIMIT) {
      grayOutInput();
      return;
    }

    ws.send(JSON.stringify({ type: 'message', text }));
    messageInput.value = '';
  };

  chatForm.addEventListener('submit', sendMessage);

  // Handle file uploads
  fileUploadInput.addEventListener('change', () => {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert('WebSocket not connected.');
      fileUploadInput.value = '';
      return;
    }

    const file = fileUploadInput.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert('File too large (max 5MB)');
      fileUploadInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const base64Data = reader.result.split(',')[1];
      ws.send(JSON.stringify({
        type: 'file',
        name: file.name,
        mime: file.type,
        data: base64Data,
      }));
    };
    reader.readAsDataURL(file);

    fileUploadInput.value = '';
  });

  // Name submit button
  nameSubmit.addEventListener('click', () => {
    const val = nameInput.value.trim();
    if (val.length < 1 || val.length > 16) {
      alert('Name must be between 1 and 16 characters');
      return;
    }
    myName = val;
    nameOverlay.style.display = 'none';
    connectWebSocket();
  });

  // Also allow Enter key to submit name
  nameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      nameSubmit.click();
    }
  });

})();

</script>
</body>
</html>
